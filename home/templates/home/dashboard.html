{% extends 'base.html' %}
{% load static %}
{% block content %}
{% load plotly_dash %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script>
  $(document).ready(function() {
      $(function() {
          $('#importantGraph option:contains({{selectedImportantGraph}})').prop('selected',true);
          $('#dataName option:contains({{selectedDataName}})').prop('selected',true);
        
          $('#sectors2').prop("disabled", true);
          $('#sectors3').prop("disabled", true);
          $('#sectors4').prop("disabled", true);

          $('#sectors1 option:contains({{selectedSector1}})').prop('selected',true);
          $('#sectors2 option:contains({{selectedSector2}})').prop('selected',false);
          $('#sectors3 option:contains({{selectedSector3}})').prop('selected',false);
          $('#sectors4 option:contains({{selectedSector4}})').prop('selected',false);

          $('#tooltip1').attr('data-original-title', "{{selectedSectorsDefinitions1}}");
          $('#tooltip2').attr('data-original-title', "{{selectedSectorsDefinitions2}}");
          $('#tooltip3').attr('data-original-title', "{{selectedSectorsDefinitions3}}");
          $('#tooltip4').attr('data-original-title', "{{selectedSectorsDefinitions4}}");

          $('#plotType option:contains({{selectedPlot}})').prop('selected',true);
          $('#makePredictions option:contains({{selectedPredictionMode}})').prop('selected',true);
      });

    function handleSectorVisibility(counterSectorArray, selectedSectors) {
          console.log(selectedSectors)
        for(let i=1;i<=4;i++){
            if(counterSectorArray.includes(i)){
                $('#sectors'+i).prop("disabled", false);
                $('#sectors'+i+' option:contains('+selectedSectors[i-1]+')').prop('selected',true);
            }
            else{
                $('#sectors'+i+' option:nth-child(1)').prop('selected',true);
                $('#sectors'+i).prop("disabled", true);
            }
        }
      }
      
    $( "#plotType, .sectorDropdowns" ).change(function() {
        $(document).ajaxStart(function(){
                $("#plot").html('<div class="d-flex justify-content-center" style="padding-top:285px;padding-bottom:285px;"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div></div>')         
        });  
        $.get('', $( "#select_filter_form" ).serialize(), function( data ) {
            
            $('#plot').html(data.plot)
            
            //reloading tooltips
            $('#tooltip1').attr('data-original-title', data.selectedSectorsDefinitions[0])
            $('#tooltip2').attr('data-original-title', data.selectedSectorsDefinitions[1])
            $('#tooltip3').attr('data-original-title', data.selectedSectorsDefinitions[2])
            $('#tooltip4').attr('data-original-title', data.selectedSectorsDefinitions[3])

        }, "json");
      });

    $('[data-toggle="tooltip"]').tooltip()
    
      
      $('input[value="+"]').on('click', function(){

        event.preventDefault();

        let req = $( "#select_filter_form" ).serializeArray()
        req.push({ name: "addSector", value: "+" })
        $(document).ajaxStart(function(){
                $("#plot").html('<div class="d-flex justify-content-center" style="padding-top:285px;padding-bottom:285px;"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div></div>')         
        });  

        $.get('', req, function( data ) {
            $('#plot').html(data.plot)
            handleSectorVisibility(data.counterSectorArray, data.selectedSectors)
        }, "json");
        
      })

      $('input[value="-"]').on('click', function(){
        event.preventDefault();

        let req = $( "#select_filter_form" ).serializeArray()
        req.push({ name: "removeSector", value: "-" })
        $(document).ajaxStart(function(){
                $("#plot").html('<div class="d-flex justify-content-center" style="padding-top:285px;padding-bottom:285px;"><div class="spinner-border text-primary" role="status"><span class="sr-only">Loading...</span></div></div>')         
        });  
        
        $.get('', req, function( data ) {
            $('#plot').html(data.plot)
            handleSectorVisibility(data.counterSectorArray, data.selectedSectors)
        }, "json");
        
      })
      
      
  });
  
</script>

<form id="select_filter_form" method="GET" action="." >
    <div class="form-group col-md-3 float-left">
        <label for="importantGraph">Important Graphs</label>
        <select id="importantGraph" class="form-control" name="importantGraph" width="100%" onchange="this.form.submit()">
            <option selected disabled>Choose...</option>
            {% for importantGraph in importantGraphs %}
            <option value="{{ importantGraph }}">{{ importantGraph }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group shadow-sm col-md-4 float-right" style="margin-top:90px">
        <!-- tab list -->
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <a class="nav-item nav-link active" id="nav-default-tab" data-toggle="tab" href="#nav-default" role="tab" aria-controls="nav-default" aria-selected="true">Default</a>
            <a class="nav-item nav-link" id="nav-custom-tab" data-toggle="tab" href="#nav-custom" role="tab" aria-controls="nav-custom" aria-selected="false">Add Customized Graph</a>
            </div>
        </nav>
        <br/>
        <!-- default tab -->
        <div class="tab-content" id="nav-tabContent">
            <div class="tab-pane fade show active" id="nav-default" role="tabpanel" aria-labelledby="nav-default-tab">
                <label for="dataName">Data 
                    {% if selectedDataName == "Flow of Funds" %}
                    <svg class="bi bi-question-circle" width="1.0em" height="1.0em" viewBox="0 0 16 16" fill="rgb(50, 50, 150)" xmlns="http://www.w3.org/2000/svg" data-toggle="tooltip" data-placement="bottom" title="
                    Flow of funds (FOF) are financial accounts that are used to track the net inflows and outflows of money to and from various sectors of a national economy. Macroeconomic data from flow of funds accounts are collected and analyzed by a country's central bank. In the United States, this data is released by the Federal Reserve Bank approximately 10 weeks after the end of each quarter. 
                    Note that a different term 'fund flows' is used to denote the amount of assets moving in and out of different types of mutual funds, e.g. among equity and fixed income funds.
                    ">
                        <path fill-rule="evenodd" d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z" clip-rule="evenodd"/>
                        <path d="M5.25 6.033h1.32c0-.781.458-1.384 1.36-1.384.685 0 1.313.343 1.313 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.007.463h1.307v-.355c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.326 0-2.786.647-2.754 2.533zm1.562 5.516c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                    </svg>
                    {% endif %}
                    {% if selectedDataName == "Balance Sheet (Annual)" or selectedDataName == "Balance Sheet (Monthly)" %}
                    <svg class="bi bi-question-circle" width="1.2em" height="1.2em" viewBox="0 0 16 16" fill="rgb(50, 50, 150)" xmlns="http://www.w3.org/2000/svg" data-toggle="tooltip" data-placement="bottom" title="
                    A balance sheet is a financial statement that reports a company's assets, liabilities and shareholders' equity at a specific point in time, and provides a basis for computing rates of return and evaluating its capital structure. It is a financial statement that provides a snapshot of what a company owns and owes, as well as the amount invested by shareholders.
                    The balance sheet is used alongside other important financial statements such as the income statement and statement of cash flows in conducting fundamental analysis or calculating financial ratios.
                    The balance sheet adheres to the following accounting equation: Assets = Liabilities + Shareholders' Equity. The formula is intuitive: a company has to pay for all the things it owns (assets) by either borrowing money (taking on liabilities) or taking it from investors (issuing shareholders' equity). 
                    ">
                        <path fill-rule="evenodd" d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z" clip-rule="evenodd"/>
                        <path d="M5.25 6.033h1.32c0-.781.458-1.384 1.36-1.384.685 0 1.313.343 1.313 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.007.463h1.307v-.355c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.326 0-2.786.647-2.754 2.533zm1.562 5.516c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                    </svg>
                    {% endif %}
                </label>
                <select id="dataName" class="form-control" name="datas" width="100%" onchange="this.form.submit()">
                    {% for dataName in dataNames %}
                    <option value="{{ dataName }}">{{ dataName }}</option>
                    {% endfor %}
                </select>
                <br/>
                <label for="plotType">Plot type</label>
                <select id="plotType" class="form-control" name="plots" width="100%">
                    {% for plotType in plotTypes %}
                    <option value="{{ plotType }}">{{ plotType }}</option>
                    {% endfor %}
                </select>
                <br/>

                <label for="sectors1">Sector 1</label>
                <svg id="tooltip1" class="bi bi-question-circle" width="1.0em" height="1.0em" viewBox="0 0 16 16" fill="rgb(50, 50, 150)" xmlns="http://www.w3.org/2000/svg" title= "" data-toggle="tooltip" data-placement="bottom">
                    <path fill-rule="evenodd" d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z" clip-rule="evenodd"/>
                    <path d="M5.25 6.033h1.32c0-.781.458-1.384 1.36-1.384.685 0 1.313.343 1.313 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.007.463h1.307v-.355c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.326 0-2.786.647-2.754 2.533zm1.562 5.516c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
                <div>
                    <select id="sectors1" class="form-control mr-3 sectorDropdowns" name="sectors1" width="100%">
                        <option selected disabled>Choose...</option>
                        {% for sector in sectors %}
                        <option value="{{ sector }}">{{ sector }}</option>
                        {% endfor %}
                    </select>       
                </div>
                <br/>
                
                
                <label for="sectors2">Sector 2</label>
                <svg id="tooltip2" class="bi bi-question-circle" width="1.0em" height="1.0em" viewBox="0 0 16 16" fill="rgb(50, 50, 150)" xmlns="http://www.w3.org/2000/svg" data-toggle="tooltip" data-placement="bottom" title= "">
                    <path fill-rule="evenodd" d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z" clip-rule="evenodd"/>
                    <path d="M5.25 6.033h1.32c0-.781.458-1.384 1.36-1.384.685 0 1.313.343 1.313 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.007.463h1.307v-.355c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.326 0-2.786.647-2.754 2.533zm1.562 5.516c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
                <div>
                    <select id="sectors2" class="form-control mr-3 sectorDropdowns" name="sectors2" width= "100%">
                        <option selected disabled>Choose...</option>
                        {% for sector in sectors %}
                        <option value="{{ sector }}">{{ sector }}</option>
                        {% endfor %}
                    </select>
                </div>
                <br/>
                

                
                <label for="sectors3">Sector 3</label>
                <svg id="tooltip3" class="bi bi-question-circle" width="1.0em" height="1.0em" viewBox="0 0 16 16" fill="rgb(50, 50, 150)" xmlns="http://www.w3.org/2000/svg" data-toggle="tooltip" data-placement="bottom" title= "">
                    <path fill-rule="evenodd" d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z" clip-rule="evenodd"/>
                    <path d="M5.25 6.033h1.32c0-.781.458-1.384 1.36-1.384.685 0 1.313.343 1.313 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.007.463h1.307v-.355c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.326 0-2.786.647-2.754 2.533zm1.562 5.516c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
                <div>
                    <select id="sectors3" class="form-control mr-3 sectorDropdowns" name="sectors3" width= "100%">
                        <option selected disabled>Choose...</option>
                        {% for sector in sectors %}
                        <option value="{{ sector }}">{{ sector }}</option>
                        {% endfor %}
                    </select>
                </div>
                <br/>
                
                

                
                <label for="sectors4">Sector 4</label>
                <svg id="tooltip4" class="bi bi-question-circle" width="1.0em" height="1.0em" viewBox="0 0 16 16" fill="rgb(50, 50, 150)" xmlns="http://www.w3.org/2000/svg" data-toggle="tooltip" data-placement="bottom" title= "">
                    <path fill-rule="evenodd" d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z" clip-rule="evenodd"/>
                    <path d="M5.25 6.033h1.32c0-.781.458-1.384 1.36-1.384.685 0 1.313.343 1.313 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.007.463h1.307v-.355c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.326 0-2.786.647-2.754 2.533zm1.562 5.516c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/>
                </svg>
                <div>
                    <select id="sectors4" class="form-control mr-3 sectorDropdowns" name="sectors4" width= "100%">
                        <option selected disabled>Choose...</option>
                        {% for sector in sectors %}
                        <option value="{{ sector }}">{{ sector }}</option>
                        {% endfor %}
                    </select>
                </div>
                <br/>
                
                
                <div class="row">
                    <div class="form-group col-md-9 ">
                        <input type="submit"
                                name="addSector"
                                value="+"
                                class="btn btn-outline-primary"
                               >

                        <input type="submit"
                                name="removeSector"
                                value="-"
                                class="btn btn-outline-primary"
                                ><span class="ml-2"><label>Add / Remove Sector</label></span>
                    </div>
                </div>
                <div class="form-group col-md-7 float-right">
                    <select id="makePredictions" class="form-control" name="makePredictions" width="100%" onchange="this.form.submit()">
                        <option selected>Disable Forecast</option>
                        <option>Enable Forecast</option>
                    </select>
                </div>
            </div>
            <!-- Custom Graph Tab -->
            <div class="tab-pane fade" id="nav-custom" role="tabpanel" aria-labelledby="nav-custom-tab">
                <label for="dataName">Data</label>
                <select id="dataName" class="form-control" name="datas" width="100%">
                    {% for dataName in dataNames %}
                    <option value="{{ dataName }}">{{ dataName }}</option>
                    {% endfor %}
                </select>
                <br/>

                <label for="sectors1" class="mx-auto">Sector 1</label>
                <div>
                    <select id="sectors1custom" class="form-control mr-3" name="sectors1custom"  width="100%">
                        {% for sector in sectors %}
                        <option value="{{ sector }}">{{ sector }}</option>
                        {% endfor %}
                    </select>                  
                </div>
                <br/><br/>
                <div>
                    <select id="operatorCustom" class="form-control mr-3 col-md-2 mx-auto" style="text-align-last: center" name="operatorCustom" width="100%">
                        <option value="+">+</option>
                        <option value="-">-</option>
                        <option value="*">*</option>
                        <option value="/">/</option>
                    </select>                  
                </div>
                <br/><br/>
                <label for="sectors2" class="mx-auto">Sector 2</label>
                <div>
                    <select id="sectors2custom" class="form-control mr-3" name="sectors2custom" width="100%">
                        {% for sector in sectors %}
                        <option value="{{ sector }}">{{ sector }}</option>
                        {% endfor %}
                    </select>                  
                </div>
                <br><br>
                <button
                    class="btn btn-outline-primary float-right" 
                    type="button"
                    onclick="return false"
                    data-target="#customNameModal"
                    data-toggle="modal"
                    style="margin-bottom: 20px">Create Custom Entry</button>


                <div class="modal" id="customNameModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Custom Entry</h4>
                                <button class="close" data-dismiss="modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <input class="form-control" placeholder="Enter the name of the new Entry" type="text" id="inputEntryName" name="inputEntryName"/>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-primary" name="saveCustom" onclick="this.form.submit()">Save</button>
                                <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="plot" class="p-3 mb-5 bg-transparent text-white rounded col-sm-8 float-left">
    {{ plot | safe }} 
    </div>
    
</form>

        
{% endblock %}
